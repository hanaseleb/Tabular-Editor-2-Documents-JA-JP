2020-05-03
ダニエル・オティキエル
テーブルのインポート

すでにモデルにレガシーデータソースがある場合は、それを右クリックして、"Import Tables... "を選択することができます。Tabular Editorは、データソースで指定されているデータプロバイダと認証情報を使って接続を試みます。成功すれば、データソースからアクセスできるすべてのデータベース、テーブル、ビューのリストが表示されます。

https://user-images.githubusercontent.com/8976200/49701892-35ea3900-fbf2-11e8-951a-8858179426c6.png

左側のテーブルやビューをクリックすると、右側にデータのプレビューが表示されます。データインポートのベストプラクティスでは、常にビューを使用し、タブラーモデルで必要とされるビューの列のみを含めることが推奨されていますが、含めたくない列を選択解除することができます。UIには結果のSQLクエリが表示されます。デフォルトでは、Tabular EditorはSELECT * FROM ...を使ってテーブル/ビューをインポートしますが、プレビューでいずれかの列を切り替えると、結果のクエリには列の明示的なリストが含まれます。SELECT * FROM ...に戻すには、右上の「Select all columns」チェックボックスをトグルします。

一度に複数のテーブル/ビューを選択してインポートすることができます。インポート "をクリックすると、選択されたすべてのテーブル/ビューが、メタデータからすべての列が入力された新しいテーブルとしてインポートされます。各テーブルには1つのパーティションが作成され、UIからのSQLクエリの結果が保持されます。

これで完了です。もうTabular EditorとSSDTの間を行ったり来たりする必要はありません。

レガシーデータソースと構造化データソースに関する注意点
現在、Tabular EditorにはM（Power Query）式から返されるメタデータを推論する方法がないため、このUIはレガシー（別名：プロバイダー）データソースのみをサポートしています。ストラクチャード データ ソースを使用する必要がある場合でも、一時的なレガシー接続を使用してテーブル スキーマを最初にインポートし（データ ソースが SQL、OLE DB、または ODBC を介してアクセスできることが前提）、インポートしたテーブルのパーティションを手動で切り替えてストラクチャード データ ソースを使用することができます。WebサービスやAzure Data Lake Storageなどの「エキゾチック」なデータソースからデータをインポートする場合、スキーマメタデータは自動的にはインポートできませんが、クリップボードを介してメタデータ情報を提供するオプションがあります。

しかし、一般的には、以下のタイプのソースに対しては、常にレガシー接続を使用することが推奨されます。

SQL Server データベース
Azure SQL データベース
Azure SQL データウェアハウス
Azure Databricks (ODBC経由)
あらゆるリレーショナルOLEDBデータソース
任意のリレーショナルODBCソース
Azure Active Directory with MFAを使用した認証については、こちらを参照してください。

既存のデータソースがない場合のインポート
モデルにまだデータソースが含まれていない場合は、「モデル」メニューから「テーブルのインポート...」をクリックすることでテーブルをインポートできます。結果として、UIは以下のようになります。

https://user-images.githubusercontent.com/8976200/49702141-74cdbe00-fbf5-11e8-8a88-5bc2a0a6c80d.png

選択肢を「新しいデータソースを作成してモデルに追加する」にしておくと、「次へ」をクリックしたときに接続ダイアログのUIが表示されます。このダイアログでは、接続の詳細を指定することができます。

https://user-images.githubusercontent.com/8976200/49702167-a5adf300-fbf5-11e8-8d06-d6670ad456d4.png

OK」をクリックすると、指定された接続を使用した（レガシー）データソースがモデルに作成され、上述のインポートページに移動します。

リストの次のオプションである「一時的な接続を使用する」では、モデルに新しいデータソースが追加されません。つまり、モデルをデプロイする前に、新しくインポートされたテーブルのパーティションにデータソースを割り当てる必要があります。

最後のオプションである「他のアプリケーションからメタデータを手動でインポートする」は、列のメタデータのリストに基づいて新しいテーブルをインポートしたい場合に使用します。これは、後述する構造化（Power Query）データソースの場合に有効です。

SQL機能
SQL Server以外のデータソース（正確にはNative SQL Clientドライバを使用していないデータソース）の場合は、画面下部付近にある2つのドロップダウンボックスに注意してください。

https://user-images.githubusercontent.com/8976200/51613859-b952b600-1f24-11e9-8fd7-7c5269aaab26.png

Reduce rows using "のドロップダウンでは、テーブルインポートウィザードがソースのテーブルやビューから200行のデータしか取得しないため、ソースにプレビューデータを問い合わせる際に使用する行数削減句を指定できます。TOP"、"LIMIT"、"FETCH FIRST "などの一般的な行削減句を選択することができます。

識別子の引用」のドロップダウンでは、生成されるSQL文でオブジェクト名（列、テーブル）をどのように引用するかを指定できます。これは、データプレビューと、テーブルが表計算モデルにインポートされたときにテーブルパーティションクエリで使用されるSQLステートメントの両方に適用されます。デフォルトでは、角括弧が使用されますが、他の一般的な識別子の引用に変更することができます。

テーブルのソースの変更
インポートページを表示するもう一つの方法は、既存のテーブル（レガシーデータソースを使用している）を右クリックして、「列の選択...」を選択することです。そのテーブルが以前にUIを使ってインポートされていれば、インポートページにソーステーブル/ビューとインポートされた列があらかじめ選択された状態で表示されます。列を追加/削除したり、モデルで選択したテーブルの代わりに全く別のテーブルを選択してインポートすることもできます。選択が解除されたり、ソーステーブル/ビューに存在しなくなったテーブルの列は、モデルから削除されることに注意してください。このような操作は、CTRL+Z でいつでも取り消すことができます。

テーブルのメタデータの更新
バージョン2.8のTabular Editorには、スキーマのドリフトを簡単にチェックできる新しいUI機能があります。つまり、データ型が変更された列や、ソーステーブルやビューに追加または削除された列を検出することができます。このチェックは、モデル・レベル（これもレガシー・データ・ソースにのみ適用されます）、データ・ソース・レベル、テーブル・レベル、またはパーティション・レベルで呼び出すことができます。これは、オブジェクトを右クリックして、"Refresh Table Metadata... "を選択することで行われます。

https://user-images.githubusercontent.com/8976200/49702346-7e582580-fbf7-11e8-9a62-04c6963179e5.png

変更は、それぞれのテーブル上のすべてのデータ列の「ソース列」と「データタイプ」のプロパティに基づいて検出されます。変更が検出されると、Tabular Editorは上記のUIを表示し、変更の詳細を表示します。モデルに適用したくない変更を選択解除することができますが、一部の変更は処理エラーを引き起こす可能性があることに留意してください (たとえば、ソーステーブル/ビュー/クエリに存在しないソース列など)。

このメカニズムは（テーブルのインポートUIと同様に）、ソースからメタデータを照会する際にFormatOnlyフラグを使用します。これは、ストアド プロシージャを使用するテーブル パーティションがあることを意味します。FormatOnly フラグは、ストアド・プロシージャが直接実行されないことを保証します。代わりに、サーバーが静的解析を行い、ストアド・プロシージャの実行時に返される結果セットを記述したメタデータのみを返すようになっています。RDBMS によっては、ストアド・プロシージャで FormatOnly フラグを使用する際にいくつかの制限がある場合があります。SQL Serverをデータソースとして使用する場合のこのトピックに関する詳細については、こちらの記事を参照してください。

CLIサポート
SC フラグを使用することで、コマンドラインからモデルレベルのスキーマチェックを行うことができます。CLIで実行されたスキーマチェックは、マッピングの問題を報告するだけであることに注意してください。モデルに変更を加えることはありません。マッピングの問題は、モデルをテスト/プロダクション環境にデプロイした後に問題を引き起こす可能性があるため、CI/CDパイプラインでTabular Editorを使用している場合、これは便利です。

オブジェクトの無視
Tabular Editor 2.9.8では、スキーマのチェックやメタデータの更新からオブジェクトを除外することができます。これを制御するには、除外したいオブジェクトにアノテーションを設定します。アノテーションの名前には、以下のコードを使用します。アノテーションの値は、空白にすることも、"1"、"true"、"yes "にすることもできます。注釈値を "0"、"false"、"no "に設定すると、あたかも注釈が存在しないかのように、事実上無効になります。

テーブルフラグ。

TabularEditor_SkipSchemaCheck。Tabular Editorがこのテーブルのスキーマチェックを完全にスキップするようにします。
TabularEditor_IgnoreSourceColumnAdded：このテーブルのテーブル列にマッピングされていない追加の列をTabular Editorが無視します。
TabularEditor_IgnoreDataTypeChange：データタイプの変更を無視します。TabularEditor_IgnoreDataTypeChange: テーブルの任意の列で不一致のデータ型があっても無視します。
TabularEditor_IgnoreMissingSourceColumn: インポートされた列を無視します。Tabular Editorは、ソース列が明らかにソースに存在しない場合、インポートされた列を無視します。
列のフラグです。

TabularEditor_IgnoreDataTypeChange：データタイプの変更を無視します。TabularEditor_IgnoreDataTypeChange: TabularEditorはこの特定の列でのデータ型の不一致を無視します。
TabularEditor_IgnoreMissingSourceColumn: ソースに存在しない列を無視します。TabularEditor_IgnoreMissingSourceColumn: この特定のカラムに明らかに欠けているソースカラムを無視します。
このフラグはUIとCLIの両方でのスキーマチェックに影響を与えます。

警告をエラーとして扱う
デフォルトでは、パーティション・クエリが実行できなかった場合、あるいは、インポートされたテーブルにソース・クエリのどの列にも一致しない列が含まれている場合、CLIはエラーを報告します。CLIは、列のデータ型がソース・クエリの列と一致しない場合、またはソース・クエリにインポート・テーブルのどの列にもマッピングされていない列が含まれている場合、警告を報告します。また、同じテーブルの異なるパーティションのソース・クエリが同じ列を返さない場合、CLIは警告を報告します。

Tabular Editorバージョン2.14.1から、上記のようなすべての警告がエラーとして報告されるようにCLIの動作を変更することができます。これを行うには、モデルレベルで次のアノテーションを追加します。

TabularEditor_SchemaCheckNoWarnings: TabularEditor_SchemaCheckNoWarnings：Tabular Editorがすべてのスキーマチェック警告をエラーとして扱うようにします。
MFAを使用したAzure Active Directory
Azure SQL DatabaseやAzure Synapse SQLプールからテーブルをインポートする場合、Azure Active Directoryの多要素認証が必要になると思われます。残念ながら、.NET Frameworkで使用されているSQL Native Clientプロバイダではサポートされていません。代わりに、MSOLEDBSQL プロバイダーを使用してください（Analysis Services がテーブルからデータを読み取る際に、一般的にネイティブクライアントよりも高速であるという利点もあります）。ローカルマシンで動作させるためには、このドライバーの最新（x86）バージョンがインストールされていることを確認してください。

ここでは、MFAで動作するデータソースを設定するための手順を説明します。

新しいレガシーデータソースを作成して、モデルに追加します。モデル＞新規データソース（レガシー）
System.Data.OleDbをProviderプロパティとして指定し、以下のような接続文字列を使用して、正しいサーバー名、データベース名、ユーザー名を置き換えます。
Synapse SQLプールの場合。
Provider=MSOLEDBSQL;Data Source=<synapse workspace name>-ondemand.sql.azuresynapse.net;User ID=daniel@adventureworks.com;Database=<database name>;Authentication=ActiveDirectoryInteractive
Azure SQLデータベースの場合
Provider=MSOLEDBSQL;Data Source=<sql server name>.database.windows.net;User ID=daniel@adventureworks.com;Database=<database name>;Authentication=ActiveDirectoryInteractive
このソースからテーブルをインポートするには、データソースを右クリックして「Import Tables...」を選択すると、インポートテーブルウィザードのUIが表示され、ソースからのテーブル/ビューのリストが表示されます。Synapse SQLプールでは、データのプレビューを機能させるために、行節として「TOP (without NOLOCK)」を指定する必要がある場合があることに注意してください。
Analysis Services にモデルをデプロイする際には、テーブル データの更新時に Analysis Services がソースに対して認証を行うために、サービス プリンシパルのアプリケーション ID とシークレット、または SQL アカウントなど、その他の資格情報を指定する必要がある場合がほとんどです。この認証情報は、TMSL や SSMS を使ってデプロイ後に指定することもできますし、CI/CD デプロイ パイプラインの一部として設定することもできます。
スキーマ/メタデータを手動でインポートする
テーブルのインポート ウィザードでサポートされていないデータ ソースを使用している場合は、メタデータを手動でインポートすることができます。このオプションでは、左側にテーブル スキーマを入力またはペーストできる UI が表示され、カラム名とデータ型の情報が自動的に解析されます。または、右側に各カラム名を手動で入力し、ドロップダウンでデータタイプを選択することもできます。いずれにしても、テーブルを作成してからメインのUIで個々のデータ列を追加するよりも、この方法の方が早いです。完了したら「インポート！」を押して、テーブル名とパーティション式を調整します。

左側のテキストを解析する際、Tabular Editorは、情報がどのように構成されているかを判断するために、特定のキーワードを検索します。データの解釈方法はかなり自由なので、例えば、CREATE TABLE SQLスクリプトの列リストや、以下に説明するPower Query Table.Schema(...)関数の出力を貼り付けることができます。唯一の要件は、テキストの各行がソースデータの1列を表すことです。

https://user-images.githubusercontent.com/8976200/70419758-6f07f400-1a66-11ea-838d-9a587c8021ca.png

Power Query データソース
Power Query/M式を実行したり検証したりする方法は公式にはサポートされていないので、Tabular EditorはPower Queryデータソースを限定的にしかサポートしていません。2.9.0では、前述のテーブルのインポートウィザードの「他のアプリケーションからメタデータを手動でインポート」オプションを使用して、ExcelやPower BI DesktopのPower Queryクエリからスキーマをインポートすることができます。作業の流れは以下のようになります。

まず、モデルにPower Queryのデータソースが含まれていることを確認します。データソース」を右クリックし、「新規データソース（Power Query）」を選択します。SQL Serverからデータを読み込む場合は、プロトコルに「tds」を指定し、「Database」「Server」「AuthenticationKind」の各プロパティを記入します。https://user-images.githubusercontent.com/8976200/70418811-6dd5c780-1a64-11ea-8332-d074c6b2d5c2.png
その他のタイプのデータソースの場合は、SSDTで初期モデルと最初の数テーブルを作成し、データソースの構成を把握した上で、テーブルを追加する際にのみ以下の手法を使用した方が簡単な場合があります。
ExcelまたはPower BI DesktopのPower Queryを使用してソースデータに接続し、必要な変換を適用します。
Power Query の Advanced Editor を使用して、前の出力に Table.Schema(...) M 関数を使用するステップを追加します。https://user-images.githubusercontent.com/8976200/70416018-5562ae80-1a5e-11ea-8962-529304ce83f0.png
完全な出力プレビューを選択し、クリップボードにコピー (CTRL+A、CTRL+C) して、テーブルのインポート ウィザードのスキーマ/メタデータ テキストボックスに貼り付けます:https://user-images.githubusercontent.com/8976200/70416817-2e0ce100-1a60-11ea-9e2b-430cecf88d0a.png
読み込み！」をクリックし、テーブルの適切な名前を入力します。
最後に、Excel/Power BIで使用した元のM式（Table.Schema(...)関数で修正する前のもの）を、新しく作成したテーブルのパーティションに貼り付けます。最初のステップで指定したソースを指すようにM式を修正します。